# My personal Nix configuration

![ci-badge](https://img.shields.io/static/v1?label=Built%20with&message=nix&color=blue&style=flat&logo=nixos&link=https://nixos.org&labelColor=111212)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![NixOS](https://img.shields.io/badge/NixOS-2C4C7E?logo=nixos&logoColor=white)](https://nixos.org)
[![Home Manager](https://img.shields.io/badge/Home%20Manager-5277C3?logo=nixos&logoColor=white)](https://github.com/nix-community/home-manager)

My current repository of NixOS and Home Manager configurations for various
machines.

## File system structure

```
.
.
├── build.sh
├── flake.lock
├── flake.nix
├── modules
│   ├── nixos
│   │   ├── users.nix
│   │   ├── ...
│   │   └── gc.nix
│   └── home-manager
│       ├── git.nix
│       ├── ...
│       └── zsh.nix
└── hosts
    ├── dell-precision-7530
    │   ├── configuration.nix
    │   ├── hardware-configuration.nix
    │   └── home.nix
    └── wsl1
        ├── configuration.nix
        └── home.nix
```

- `build.sh` builds and switches both NixOS and Home-manager
- `flake.nix` defines the list of targets (NixOS and home-manager)
- `modules/nixos` modules for nixos (e.g. configuration of users)
- `modules/home-manager` modules for home-manager (e.g. configuration for user stuff)
- `host/<machine>` directory with the machine configuration (nixos and home-manager)


### Adding a new configuration

To add the configuration for a new machine on which NixOS is installed :

1. **Create a new folder**:
    - Navigate to the `hosts` subfolder.
    - Create a new directory with the desired machine name.
      ```bash
      cd hosts
      mkdir -p hosts/<machine>
      ```

2. **Copy configuration files**:
    - Copy the necessary NixOS configuration files from the existing system.
    - In most cases these will be steps to follow:
      ```bash
      cp /etc/nixos/*.nix hosts/<machine>/
      ```

3. **Update `flake.nix`**:
    - Open `flake.nix` in your preferred text editor.
    - Because `nixosConfigurations` is generated by looping over the
    list of machines it suffices to add the machine to the list
    - Example:
      ```nix
      machines = [
        "machine1"
        "machine2"
        # ...
        "new-machine"
      ];
      ```
    - To validate the configuration, run `nix flake check` without applying it

4. **Build and switch to the new configuration**:
    - Run the build script to apply the new configuration.
    - For instance
      ```bash
      sudo nixos-rebuild switch --flake ./#machine
      # or alternatively
      sudo ./build.sh
      ```

By following these steps, you can easily add and configure a new machine in your NixOS setup.

## System management

### Install

To apply a configuration locally

```bash
sudo nixos-rebuild switch --flake ./#machine
# or alternatively
sudo ./build.sh
```

If the machine is remote and access via SSH is possible

```bash
NIX_SSHOPTS="-p <port>" nixos-rebuild switch --flake ./#machine --build-host <user>@<machine> --target-host <user>@<machine> --use-remote-sudo"
```

### Upgrade

Because the Nix packages are locked using flakes (in `flake.lock`)
upgrading the system requires two steps:
1. Upgrading the nix packages version in the lock file
2. Request `nixos-upgrade` to perform the upgrade

```bash
nix flake update
sudo nixos-rebuild switch --flake ./#machine --upgrade
# or alternatively
sudo ./build.sh --upgrade
```

### Other

To add a secret, first edit the `secrets/secrets.nix` file and then

```bash
cd secrets
nix run github:ryantm/agenix -- -e <passwordfile.age>
git add <passwordfile.age>
```
